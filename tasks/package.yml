# This source file is subject to the (Open Source Initiative) BSD license
# that is bundled with this package in the LICENSE file. It is also available
# through the world-wide-web at this URL: http://www.ontic.com.au/license.html
# If you did not receive a copy of the license and are unable to obtain it through
# the world-wide-web, please send an email to license@ontic.com.au immediately.
# Copyright (c) 2010-2016 Ontic. (http://www.ontic.com.au). All rights reserved.

---

- name: Composer | Determine whether Composer is installed.
  become: yes
  stat:
    path: '{{ composer_path }}'
  register: composer_bin

- name: Composer | Download the installation file.
  become: yes
  get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-installer.php
    mode: 0755
  when: not composer_bin.stat.exists

- name: Composer | Run the installation file.
  become: yes
  command: '{{ php_executable }} composer-installer.php {% if composer_version %} --version={{ composer_version }}{% endif %}'
  args:
    chdir: /tmp
  when: not composer_bin.stat.exists

- name: Composer | Ensure Composer is globally accessible.
  become: yes
  command: 'mv /tmp/composer.phar {{ composer_path }}'
  args:
    creates: '{{ composer_path }}'
    removes: /tmp/composer.phar
  when: not composer_bin.stat.exists

- name: Composer | Update Composer to latest version.
  become: yes
  command: '{{ php_executable }} {{ composer_path }} self-update'
  register: composer_update
  changed_when: "'Updating to version' in composer_update.stdout"
  when: composer_keep_updated